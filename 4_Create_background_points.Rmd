---
title: "4_Sample_background_data"
author: "Gemma Clucas"
date: "2/23/2021"
output: github_document
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(tidyverse)
library(rgdal)
library(dismo)
library(marmap)
library(ggfortify)

select <- dplyr::select
```

### Tracking data from chick-rearing period
Read it in and find the extent of the area covered - this will be the study area.
```{r}
All <- read.csv("Chick-rearing_trips/All_chick-rearing_trips.csv", stringsAsFactors = FALSE)

# Make it spatial
coordinates(All) <- ~LON + LAT
proj4string(All) <- CRS("+proj=laea +lon_0=-26 +lat_0=-58 +units=m")
# Reproject to WGS84
All <- spTransform(All, CRS = CRS("+proj=longlat +ellps=WGS84"))

# Find the extent of the chick-rearing tracks
extent(All)
```


### Create a raster of the study area with land masked
This just creates a raster with all values set to 1, which we will use to determine where our background points will be sampled. We'll add environmental variables later.
```{r}
# Read in bathymetry raster and crop to extent
SSI_bath_WGS84 <- raster("ssi_geotif/full_ssi18a.tif") %>% 
  projectRaster(., crs=crs("+init=epsg:4326")) %>% 
  crop(., c(-27.96598, -24.623, -58.41806, -57.28708))

# Set all values to 1
x <- SSI_bath_WGS84
values(x) <- 1
```


Crop out land from the study area raster using ```mask()```.
```{r}
# Read in shapefile for land
SSI_WGS84 <- readOGR("Seamask.shp") %>% 
  crop(., c(450000, 1095192, -795043.9, -100000)) %>% 
  spTransform(., crs("+init=epsg:4326"))

# Use mask() to cut out land from the raster
mask<-mask(x, SSI_WGS84, inverse=F)

# Plot to check
plot(mask)
```


### Sample the raster layer to create 'background' points

This just creates a random sample of 'background' points across the study area raster. 

```{r}
birds<-unique(All$Ptt)
background<-data.frame()
i<-birds[1]
#RUN THROUGH EACH BIRD IN TURN
for(i in birds){
  bird<-All[All$Ptt==i,] #subset 1 bird
  back <- randomPoints(mask, n = (nrow(bird)) ,prob=F) # this was originally 3*nrow
  dat<-as.data.frame(back)
  head(dat)
  names(dat)<-c("Lon","Lat")
  dat$bird<-i
  background<-rbind(background,dat)
}
head(background)

# Plot them to check
as.data.frame(mask, xy = TRUE) %>%
  ggplot() +
  geom_raster(aes(x=x, y=y)) +
  geom_point(data = background, aes(x=Lon, y=Lat)) +
  ylab("Latitude") +
  xlab("Longitude")

```

### Bathymetry
```{r}
# Use mask() to cut out land from the bathymetry raster
# values(SSI_bath_WGS84) <- 1
bathy_mask<-mask(SSI_bath_WGS84, SSI_WGS84, inverse=F)

# Make a plot using the marmap package
dat <- marmap::as.bathy(bathy_mask)
autoplot(dat, geom=c("raster", "contour"), coast = FALSE, colour="white", size=0.1) + 
  scale_fill_gradient2(low="dodgerblue4", mid="gainsboro", high="darkgreen") +
  ylab("Latitude") +
  xlab("Longitude") +
  labs(colour = "Depth")
```



Look at google earth engine for SST/chlorophylA: https://developers.google.com/earth-engine/datasets/catalog/NASA_OCEANDATA_MODIS-Terra_L3SMI

