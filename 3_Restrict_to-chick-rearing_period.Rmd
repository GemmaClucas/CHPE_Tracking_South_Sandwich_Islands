---
title: "Discarding pre-moult trips"
author: "Gemma Clucas"
date: "2/22/2021"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(geosphere)
library(rgdal)
library(raster)
options(scipen = 999)
```

### Read in trimmed tracking data
This CSV has the data from all Ptts after splitting into trips, removing low-speed sections of trips, and removing duff trips with only 1 observed fix.
```{r}
All <- read.csv("Trimmed_trips/All_trimmed_trips.csv", stringsAsFactors = FALSE)

```


### Estimate distance from colony and plot
For each point, estimate the distance from the colony, find the max distance for each trip, and plot these max distances.
```{r}
plot_distance <- function(x, penguin){
  # select penguin
  x <- x %>% filter(Ptt == penguin)
  # Make it spatial
  coordinates(x) <- ~LON + LAT
  proj4string(x) <- CRS("+proj=laea +lon_0=-26 +lat_0=-58 +units=m")
  # Reproject to WGS84
  x <- spTransform(x, CRS = CRS("+proj=longlat +ellps=WGS84"))
  # calculate distance between current point and the colony, in metres
  x <- x %>% 
    data.frame() %>% 
    dplyr::mutate(Distance_from_colony = distHaversine(p1 = cbind(LON, LAT),    
                                                       p2 = cbind(-26.401944, -57.808056),   # colony location in decimal degrees
                                                       r = 6362895))
  # Find max distance from colony for each trip and plot
  x %>% group_by(Trip) %>% 
  summarise(Max_dist = max(Distance_from_colony)) %>% 
  ggplot(aes(x = Trip, y = Max_dist, label = Trip)) + 
  geom_line() +
  geom_label()
}

```


## Run through each penguin

### 196707
Plot the trips to see whether chick-rearing and pre-moult trips are being split up properly.
```{r}
# Pick a penguin
penguin <- 196707

# Filter dataframe
penguin_df <- All %>% filter(Ptt == penguin)

# Plot the maximum distance per trip
plot_distance(All, penguin)
```

```{r}
# Define trip(s) to remove
remove <- 31

# Remove those trips
chick_rearing_df <- All %>% 
  filter(Ptt == penguin & Trip != remove) 

# Save to df and csv
assign(paste0("chick-rearing_", penguin), chick_rearing_df) %>% 
   write.csv(., paste0("Chick-rearing_trips/", penguin, "_chick-rearing.csv", sep = ""), row.names = FALSE)

# replot distance to check it worked
plot_distance(chick_rearing_df, penguin)
```

